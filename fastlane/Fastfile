default_platform(:ios)

platform :ios do
  desc "同步证书"
  lane :sync_certs do |options|
    type = options[:type]
    if type.nil? || type == "all"
      match(type: "development", readonly: true)
      match(type: "appstore", readonly: true)
    elsif ['development', 'appstore'].include?(type)
      match(type: type, readonly: true)
    else
      UI.user_error!("type 参数必须是 'development', 'appstore' 或 'all' (默认 'all')")
    end
  end

  desc "生成/更新证书"
  lane :update_certs do |options|
    type = options[:type]
    UI.user_error!("type 参数必须是 'development' 或 'appstore'") unless ['development', 'appstore'].include?(type)
    match(type: type, force_for_new_devices: true, readonly: false)
  end

  desc "添加新设备并刷新开发证书"
  lane :add_new_device do |options|
    name = options[:name]
    udid = options[:udid]
    UI.user_error!("请提供设备名称: fastlane add_new_device name:'iPhone 15' udid:'xxx'") unless name
    UI.user_error!("请提供设备UDID: fastlane add_new_device name:'iPhone 15' udid:'xxx'") unless udid
    register_device(
      name: name,
      udid: udid
    )
    match(type: "development", force_for_new_devices: true, readonly: false)
    UI.success("设备 #{name} 已添加，且开发证书已更新！")
  end
end
